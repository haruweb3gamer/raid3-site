<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEWS編集 - RAID3</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <nav id="navbar">
        <a href="../index.html">
            <svg class="logo-svg" viewBox="0 0 726.3667 231.57715" xmlns="http://www.w3.org/2000/svg">
                <g transform="translate(-412,-327.5)">
                    <path fill="#ffffff" d="M 412,445 V 331 l 36.25,0.0195 c 39.70236,0.0214 52.44438,1.06623 64.61382,5.29835 21.50077,7.47722 35.03722,21.82265 40.74698,43.18213 2.91852,10.91777 2.6945,37.05288 -0.41515,48.43317 -6.82921,24.99271 -21.25152,41.90747 -42.19972,49.49263 -3.15061,1.14081 -5.83977,2.44977 -5.9759,2.90879 -0.13613,0.45903 12.51617,17.97453 28.11623,38.92335 15.60006,20.94881 28.51634,38.46855 28.70286,38.93276 0.18652,0.46421 -11.02435,0.72371 -24.91303,0.57666 L 511.67393,558.5 482.58697,517.5553 453.5,476.61061 453.23891,517.8053 452.97781,559 H 432.48891 412 Z m 68.20078,9.87562 c 12.15861,-2.57979 22.56871,-10.69363 28.22437,-21.99863 4.70642,-9.40757 5.89723,-16.06687 5.33639,-29.84222 -0.60389,-14.83252 -2.93334,-21.36434 -10.16533,-28.50378 -7.94303,-7.84138 -14.14884,-9.70079 -34.34621,-10.29097 L 453,363.76518 V 409.88259 456 h 10.95078 c 6.02293,0 13.33543,-0.50597 16.25,-1.12438 z M 568,558.24755 c 0,-0.4345 21.53555,-52.53045 47.85679,-115.76878 C 653.4108,352.25302 664.08802,327.5 665.45292,327.5 c 1.36368,0 11.98218,24.51367 49.1644,113.5 26.08378,62.425 47.6893,114.5125 48.01228,115.75 l 0.58722,2.25 H 741.29431 719.3718 l -6.31169,-16.5 -6.31169,-16.5 h -40.7915 -40.7915 l -1.5893,4.25 c -0.87411,2.3375 -3.55789,9.65 -5.96396,16.25 l -4.37466,12 -22.61875,0.26877 C 578.17844,558.9166 568,558.68205 568,558.24755 Z m 126,-64.80929 c 0,-0.30895 -5.36581,-14.59645 -11.92402,-31.75 -6.55821,-17.15354 -12.94832,-34.67564 -14.20026,-38.938 -1.25193,-4.26236 -2.59245,-7.41236 -2.97894,-7 -0.38649,0.41236 -1.69494,4.32651 -2.90766,8.69812 -1.21273,4.37161 -6.70328,20.12161 -12.20123,35 -5.49796,14.87839 -10.60443,28.73912 -11.34773,30.80162 l -1.35144,3.75 h 28.45564 C 681.19496,494 694,493.74722 694,493.43826 Z M 785,445 V 331 H 805.5 826 V 445 559 H 805.5 785 Z m 94.66667,113.33333 C 879.3,557.96667 879,506.62667 879,444.24445 V 330.82224 l 39.25,0.46751 c 41.28404,0.49174 45.57029,0.90035 60.71135,5.78763 31.34345,10.11713 51.21355,33.74637 59.21915,70.42262 2.8755,13.17355 3.6376,45.10965 1.4335,60.07259 -7.6233,51.75283 -36.7642,83.38026 -82.86316,89.93354 -10.62663,1.51065 -75.70239,2.20899 -77.08417,0.8272 z m 75.20237,-37.77058 c 19.71864,-5.30527 34.23089,-21.54403 40.115,-44.88745 6.49416,-25.76352 4.92088,-55.48052 -4.06216,-76.72937 C 980.43795,374.14679 964.00903,364 934.34004,364 H 922 v 79.65555 79.65555 l 13.75,-0.65191 c 7.5625,-0.35855 16.16607,-1.30194 19.11904,-2.09644 z M 1087.112,471.81347 c -6.7863,-0.76753 -18.2936,-5.73109 -23.4478,-10.11397 l -2.8357,-2.41141 4.5674,-7.12575 4.5675,-7.12574 5.5539,3.89049 c 12.3712,8.66607 27.4686,7.68657 36.2845,-2.35408 3.2104,-3.65651 5.9582,-11.06146 6.1982,-16.81169 0.3377,-8.08947 -5.1381,-17.55691 -12.4293,-20.86851 -4.6493,-2.11166 -15.756,-2.52439 -21.9145,-0.81434 -2.114,0.58703 -4.0803,0.83072 -4.3695,0.54153 -0.2892,-0.28918 5.359,-9.65948 12.5514,-20.82289 L 1104.9154,367.5 1086.7077,367 1068.5,366.5 l -0.2889,-8.75 -0.289,-8.75 32.098,0.19715 c 25.3881,0.15593 31.9502,-0.5273 31.3913,0.46141 -0.3887,0.6875 -6.4902,11.12482 -13.559,22.47117 -7.0688,11.34635 -12.8524,20.87156 -12.8524,21.16714 0,0.29557 2.2649,1.02313 5.033,1.61679 10.5431,2.2611 17.3498,8.63299 22.6769,16.90474 3.0945,4.80496 5.5,12.03856 5.6486,18.47733 0.1453,6.29408 -1.6551,13.69269 -4.6825,18.29764 -10.3437,15.73344 -26.0616,25.53892 -46.564,23.2201 z"/>
                </g>
            </svg>
        </a>
        <ul class="nav-links">
            <li><a href="../news/index.html">News</a></li>
            <li><a href="../index.html#creators">Creators</a></li>
            <li><a href="../index.html#about">About</a></li>
            <li><a href="https://suzuri.jp/RAID3" target="_blank">Store</a></li>
        </ul>
    </nav>

    <section class="news-editor">
        <div class="section-header">
            <p class="section-subtitle">Create & Edit</p>
            <h2 class="section-title">NEWS EDITOR</h2>
        </div>

        <div class="news-editor-grid">
            <form id="newsForm" class="news-editor-form">
                <div class="form-row">
                    <label for="title">タイトル</label>
                    <input id="title" name="title" type="text" required placeholder="記事タイトル">
                </div>

                <div class="form-row">
                    <label for="date">日付</label>
                    <input id="date" name="date" type="date" required>
                </div>

                <div class="form-row">
                    <label>タグ（複数選択可）</label>
                    <div class="tag-checkboxes" id="tagCheckboxes"></div>
                </div>

                <div class="form-row">
                    <label for="thumbnailUrl">サムネイルURL（任意）</label>
                    <input id="thumbnailUrl" name="thumbnailUrl" type="url" placeholder="https://... または images/xxx.png">
                </div>

                <div class="form-row">
                    <label for="thumbnailFile">サムネイル画像（任意・ローカル）</label>
                    <input id="thumbnailFile" name="thumbnailFile" type="file" accept="image/*">
                    <small>※ローカル選択時はブラウザ保存（data URL）になります。</small>
                </div>

                <div class="form-row">
                    <label for="excerpt">概要（任意）</label>
                    <textarea id="excerpt" name="excerpt" rows="2" placeholder="一覧に表示する短い説明"></textarea>
                </div>

                <div class="form-row">
                    <label for="body">本文（HTML可）</label>
                    <textarea id="body" name="body" rows="10" placeholder="<p>本文を入力</p>" required></textarea>
                    <small>※改行のみでも保存できます。簡易HTMLタグ利用可。</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">保存</button>
                    <button type="button" id="resetBtn" class="btn btn-secondary">フォームをリセット</button>
                    <button type="button" id="resetDataBtn" class="btn btn-secondary">初期データに戻す</button>
                </div>
            </form>

            <div class="news-editor-preview">
                <div class="preview-header">
                    <h3>現在のニュース一覧</h3>
                    <p class="preview-note">クリックで編集／削除</p>
                </div>
                <div id="newsList" class="news-editor-list"></div>
            </div>
        </div>
    </section>

    <footer style="text-align: center; padding: 2rem; border-top: 1px solid #2a2a2a;">
        <p style="font-size: 0.7rem; color: #666;">&copy; 2025 RAID3. All rights reserved.</p>
    </footer>

    <script src="../news-data.js"></script>
    <script>
        // 簡易アクセス制限（パスコード方式）
        const ADMIN_PASSCODE = '05120315';
        const AUTH_KEY = 'newsAdminAuth';
        (function gatekeep() {
            const stored = localStorage.getItem(AUTH_KEY);
            if (stored === ADMIN_PASSCODE) return;
            const input = prompt('ニュース編集ページのパスコードを入力してください。');
            if (input === ADMIN_PASSCODE) {
                localStorage.setItem(AUTH_KEY, ADMIN_PASSCODE);
                return;
            }
            alert('権限がありません。トップへ戻ります。');
            location.href = '../index.html';
        })();

        const form = document.getElementById('newsForm');
        const titleInput = document.getElementById('title');
        const dateInput = document.getElementById('date');
        const excerptInput = document.getElementById('excerpt');
        const bodyInput = document.getElementById('body');
        const thumbUrlInput = document.getElementById('thumbnailUrl');
        const thumbFileInput = document.getElementById('thumbnailFile');
        const tagBox = document.getElementById('tagCheckboxes');
        const listWrap = document.getElementById('newsList');
        const resetBtn = document.getElementById('resetBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');

        let editId = null;
        let fileDataUrl = '';

        function buildTagInputs() {
            tagBox.innerHTML = '';
            window.NewsData.TAGS.forEach(tag => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = tag;
                label.appendChild(input);
                label.appendChild(document.createTextNode(`#${tag}`));
                tagBox.appendChild(label);
            });
        }

        function setCheckedTags(tags = []) {
            Array.from(tagBox.querySelectorAll('input[type="checkbox"]')).forEach(input => {
                input.checked = tags.includes(input.value);
            });
        }

        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function renderList() {
            const items = window.NewsData.getAll();
            listWrap.innerHTML = '';
            if (!items.length) {
                listWrap.innerHTML = '<p class="news-empty">ニュースはありません。</p>';
                return;
            }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'news-editor-card';

                const header = document.createElement('div');
                header.className = 'news-editor-card-head';
                const title = document.createElement('h4');
                title.textContent = item.title;
                const meta = document.createElement('span');
                meta.className = 'news-editor-meta';
                meta.textContent = item.date;
                header.appendChild(title);
                header.appendChild(meta);

                const tags = document.createElement('div');
                tags.className = 'news-editor-tags';
                (item.tags || []).forEach(tag => {
                    const badge = document.createElement('span');
                    badge.className = 'news-tag';
                    badge.textContent = `#${tag}`;
                    tags.appendChild(badge);
                });

                const actions = document.createElement('div');
                actions.className = 'news-editor-actions';

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.textContent = '編集';
                editBtn.onclick = () => fillForm(item);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-secondary';
                deleteBtn.textContent = '削除';
                deleteBtn.onclick = () => {
                    if (confirm('削除しますか？')) {
                        window.NewsData.remove(item.id);
                        renderList();
                    }
                };

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);

                card.appendChild(header);
                card.appendChild(tags);
                card.appendChild(actions);
                listWrap.appendChild(card);
            });
        }

        function fillForm(item) {
            editId = item.id;
            titleInput.value = item.title || '';
            dateInput.value = item.date || '';
            excerptInput.value = item.excerpt || '';
            bodyInput.value = item.body || '';
            thumbUrlInput.value = item.thumbnail && item.thumbnail.startsWith('http') ? item.thumbnail : '';
            fileDataUrl = item.thumbnail && item.thumbnail.startsWith('data:') ? item.thumbnail : '';
            setCheckedTags(item.tags || []);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const title = titleInput.value.trim();
            if (!title) return alert('タイトルを入力してください。');

            const tags = Array.from(tagBox.querySelectorAll('input:checked')).map(i => i.value);
            const date = dateInput.value || new Date().toISOString().slice(0, 10);
            const excerpt = excerptInput.value.trim();
            const body = bodyInput.value.trim() || '<p>本文が準備中です。</p>';

            if (thumbFileInput.files[0]) {
                fileDataUrl = await readFileAsDataUrl(thumbFileInput.files[0]);
            }

            const thumbnail = fileDataUrl || thumbUrlInput.value.trim() || '';
            const payload = {
                id: editId || `news-${Date.now()}`,
                title,
                date,
                tags,
                thumbnail,
                excerpt,
                body,
                createdAt: editId ? (window.NewsData.getById(editId)?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };

            window.NewsData.upsert(payload);
            alert('保存しました。');
            editId = null;
            form.reset();
            fileDataUrl = '';
            renderList();
        }

        function resetForm() {
            editId = null;
            fileDataUrl = '';
            form.reset();
            setCheckedTags([]);
        }

        document.addEventListener('DOMContentLoaded', () => {
            buildTagInputs();
            const today = new Date().toISOString().slice(0, 10);
            dateInput.value = today;
            renderList();

            form.addEventListener('submit', handleSubmit);
            resetBtn.addEventListener('click', resetForm);
            resetDataBtn.addEventListener('click', () => {
                if (confirm('初期データに戻しますか？現在の変更は失われます。')) {
                    window.NewsData.reset();
                    renderList();
                    resetForm();
                }
            });

            thumbFileInput.addEventListener('change', () => {
                fileDataUrl = '';
            });
        });
    </script>
</body>
</html>

