<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEWSç·¨é›† - RAID3</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .export-section {
            background: #1a1a1a;
            border: 2px solid #c8ff00;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        .export-section h3 {
            color: #c8ff00;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .export-section p {
            color: #999;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }
        .export-btn {
            background: #c8ff00;
            color: #000;
            border: none;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .export-btn:hover {
            background: #fff;
            transform: scale(1.05);
        }
        .export-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .export-steps {
            background: #111;
            padding: 1rem;
            margin-top: 1rem;
            text-align: left;
            font-size: 0.8rem;
            color: #ccc;
        }
        .export-steps ol {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }
        .export-steps li {
            margin-bottom: 0.5rem;
        }
        .export-steps strong {
            color: #c8ff00;
        }

        /* ç”»åƒç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .image-manager {
            background: #1a1a1a;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #2a2a2a;
        }
        .image-manager h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #fff;
        }
        .image-upload-area {
            border: 2px dashed #444;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1rem;
        }
        .image-upload-area:hover,
        .image-upload-area.dragover {
            border-color: #c8ff00;
            background: rgba(200, 255, 0, 0.05);
        }
        .image-upload-area input { display: none; }
        .image-upload-area p { color: #999; margin: 0; font-size: 0.85rem; }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
        }
        .image-item {
            position: relative;
            aspect-ratio: 1;
            background: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-item-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.3rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            font-size: 0.6rem;
            color: #ccc;
            word-break: break-all;
        }
        .image-item-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ef4444;
            border: none;
            color: #fff;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            line-height: 1;
        }

        /* HTMLã‚¿ã‚°ãƒœã‚¿ãƒ³ */
        .html-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }
        .html-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #c8ff00;
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            font-family: monospace;
            cursor: pointer;
            transition: all 0.2s;
        }
        .html-btn:hover {
            background: #333;
            border-color: #c8ff00;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .status-bar {
            background: #111;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        .status-bar .count { color: #c8ff00; }

        /* ãƒ•ã‚©ãƒ¼ãƒ èª¿æ•´ */
        .news-editor-form textarea {
            font-family: 'Inter', monospace;
            resize: vertical;
        }
    </style>
</head>
<body>
    <nav id="navbar">
        <a href="../index.html">
            <svg class="logo-svg" viewBox="0 0 726.3667 231.57715" xmlns="http://www.w3.org/2000/svg">
                <g transform="translate(-412,-327.5)">
                    <path fill="#ffffff" d="M 412,445 V 331 l 36.25,0.0195 c 39.70236,0.0214 52.44438,1.06623 64.61382,5.29835 21.50077,7.47722 35.03722,21.82265 40.74698,43.18213 2.91852,10.91777 2.6945,37.05288 -0.41515,48.43317 -6.82921,24.99271 -21.25152,41.90747 -42.19972,49.49263 -3.15061,1.14081 -5.83977,2.44977 -5.9759,2.90879 -0.13613,0.45903 12.51617,17.97453 28.11623,38.92335 15.60006,20.94881 28.51634,38.46855 28.70286,38.93276 0.18652,0.46421 -11.02435,0.72371 -24.91303,0.57666 L 511.67393,558.5 482.58697,517.5553 453.5,476.61061 453.23891,517.8053 452.97781,559 H 432.48891 412 Z m 68.20078,9.87562 c 12.15861,-2.57979 22.56871,-10.69363 28.22437,-21.99863 4.70642,-9.40757 5.89723,-16.06687 5.33639,-29.84222 -0.60389,-14.83252 -2.93334,-21.36434 -10.16533,-28.50378 -7.94303,-7.84138 -14.14884,-9.70079 -34.34621,-10.29097 L 453,363.76518 V 409.88259 456 h 10.95078 c 6.02293,0 13.33543,-0.50597 16.25,-1.12438 z M 568,558.24755 c 0,-0.4345 21.53555,-52.53045 47.85679,-115.76878 C 653.4108,352.25302 664.08802,327.5 665.45292,327.5 c 1.36368,0 11.98218,24.51367 49.1644,113.5 26.08378,62.425 47.6893,114.5125 48.01228,115.75 l 0.58722,2.25 H 741.29431 719.3718 l -6.31169,-16.5 -6.31169,-16.5 h -40.7915 -40.7915 l -1.5893,4.25 c -0.87411,2.3375 -3.55789,9.65 -5.96396,16.25 l -4.37466,12 -22.61875,0.26877 C 578.17844,558.9166 568,558.68205 568,558.24755 Z m 126,-64.80929 c 0,-0.30895 -5.36581,-14.59645 -11.92402,-31.75 -6.55821,-17.15354 -12.94832,-34.67564 -14.20026,-38.938 -1.25193,-4.26236 -2.59245,-7.41236 -2.97894,-7 -0.38649,0.41236 -1.69494,4.32651 -2.90766,8.69812 -1.21273,4.37161 -6.70328,20.12161 -12.20123,35 -5.49796,14.87839 -10.60443,28.73912 -11.34773,30.80162 l -1.35144,3.75 h 28.45564 C 681.19496,494 694,493.74722 694,493.43826 Z M 785,445 V 331 H 805.5 826 V 445 559 H 805.5 785 Z m 94.66667,113.33333 C 879.3,557.96667 879,506.62667 879,444.24445 V 330.82224 l 39.25,0.46751 c 41.28404,0.49174 45.57029,0.90035 60.71135,5.78763 31.34345,10.11713 51.21355,33.74637 59.21915,70.42262 2.8755,13.17355 3.6376,45.10965 1.4335,60.07259 -7.6233,51.75283 -36.7642,83.38026 -82.86316,89.93354 -10.62663,1.51065 -75.70239,2.20899 -77.08417,0.8272 z m 75.20237,-37.77058 c 19.71864,-5.30527 34.23089,-21.54403 40.115,-44.88745 6.49416,-25.76352 4.92088,-55.48052 -4.06216,-76.72937 C 980.43795,374.14679 964.00903,364 934.34004,364 H 922 v 79.65555 79.65555 l 13.75,-0.65191 c 7.5625,-0.35855 16.16607,-1.30194 19.11904,-2.09644 z M 1087.112,471.81347 c -6.7863,-0.76753 -18.2936,-5.73109 -23.4478,-10.11397 l -2.8357,-2.41141 4.5674,-7.12575 4.5675,-7.12574 5.5539,3.89049 c 12.3712,8.66607 27.4686,7.68657 36.2845,-2.35408 3.2104,-3.65651 5.9582,-11.06146 6.1982,-16.81169 0.3377,-8.08947 -5.1381,-17.55691 -12.4293,-20.86851 -4.6493,-2.11166 -15.756,-2.52439 -21.9145,-0.81434 -2.114,0.58703 -4.0803,0.83072 -4.3695,0.54153 -0.2892,-0.28918 5.359,-9.65948 12.5514,-20.82289 L 1104.9154,367.5 1086.7077,367 1068.5,366.5 l -0.2889,-8.75 -0.289,-8.75 32.098,0.19715 c 25.3881,0.15593 31.9502,-0.5273 31.3913,0.46141 -0.3887,0.6875 -6.4902,11.12482 -13.559,22.47117 -7.0688,11.34635 -12.8524,20.87156 -12.8524,21.16714 0,0.29557 2.2649,1.02313 5.033,1.61679 10.5431,2.2611 17.3498,8.63299 22.6769,16.90474 3.0945,4.80496 5.5,12.03856 5.6486,18.47733 0.1453,6.29408 -1.6551,13.69269 -4.6825,18.29764 -10.3437,15.73344 -26.0616,25.53892 -46.564,23.2201 z"/>
                </g>
            </svg>
        </a>
        <ul class="nav-links">
            <li><a href="index.html">News</a></li>
            <li><a href="../index.html#creators">Creators</a></li>
            <li><a href="../index.html#about">About</a></li>
            <li><a href="https://suzuri.jp/RAID3" target="_blank">Store</a></li>
        </ul>
    </nav>

    <section class="news-editor">
        <div class="section-header">
            <p class="section-subtitle">Create & Edit</p>
            <h2 class="section-title">NEWS EDITOR</h2>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
        <div class="status-bar">
            <span>è¨˜äº‹æ•°: <strong class="count" id="newsCount">0</strong> | ç”»åƒæ•°: <strong class="count" id="imageCount">0</strong></span>
            <button class="btn btn-secondary" onclick="clearAllData()" style="padding: 0.5rem 1rem; font-size: 0.75rem;">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        </div>

        <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="export-section">
            <h3>ğŸ“¦ ã‚µã‚¤ãƒˆã«å…¬é–‹ã™ã‚‹</h3>
            <p>ç·¨é›†ãŒå®Œäº†ã—ãŸã‚‰ã€ã“ã®ãƒœã‚¿ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
            <button class="export-btn" onclick="exportZip()" id="exportZipBtn">
                ğŸ“¥ ZIPã§ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
            <div class="export-steps">
                <strong>ZIPãƒ•ã‚¡ã‚¤ãƒ«ã«å«ã¾ã‚Œã‚‹ã‚‚ã®ï¼š</strong>
                <ol>
                    <li><strong>news-data.js</strong>ï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼‰</li>
                    <li><strong>news/001.html, 002.html...</strong>ï¼ˆå€‹åˆ¥è¨˜äº‹HTMLã€OGPå¯¾å¿œï¼‰</li>
                    <li><strong>images/</strong>ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒï¼‰</li>
                </ol>
                <strong>å…¬é–‹æ‰‹é †ï¼š</strong>
                <ol>
                    <li>ä¸Šã®ãƒœã‚¿ãƒ³ã§ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                    <li>ZIPã‚’è§£å‡</li>
                    <li>GitHubã® raid3-site ãƒªãƒã‚¸ãƒˆãƒªã‚’é–‹ã</li>
                    <li>è§£å‡ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</li>
                    <li>ã€ŒCommit changesã€â†’ VercelãŒè‡ªå‹•æ›´æ–°ï¼</li>
                </ol>
            </div>
        </div>

        <!-- ç”»åƒç®¡ç† -->
        <div class="image-manager">
            <h3>ğŸ–¼ï¸ ç”»åƒç®¡ç†</h3>
            <div class="image-upload-area" id="imageUploadArea">
                <p>ğŸ“ ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ç”»åƒã‚’è¿½åŠ </p>
                <p style="font-size: 0.75rem; margin-top: 0.5rem;">PNG, JPG, GIF, WebPå¯¾å¿œ</p>
                <input type="file" id="imageInput" accept="image/*" multiple>
            </div>
            <div class="image-grid" id="imageGrid"></div>
        </div>

        <div class="news-editor-grid">
            <form id="newsForm" class="news-editor-form">
                <input type="hidden" id="editId">

                <div class="form-row">
                    <label for="newsId">IDï¼ˆåŠè§’è‹±æ•°å­—ã€ä¾‹: 001ï¼‰</label>
                    <input id="newsId" name="newsId" type="text" placeholder="001" required>
                </div>

                <div class="form-row">
                    <label for="title">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input id="title" name="title" type="text" required placeholder="è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«">
                </div>

                <div class="form-row">
                    <label for="date">æ—¥ä»˜</label>
                    <input id="date" name="date" type="date" required>
                </div>

                <div class="form-row">
                    <label>ã‚¿ã‚°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                    <div class="tag-checkboxes" id="tagCheckboxes"></div>
                </div>

                <div class="form-row">
                    <label for="thumbnailUrl">ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒãƒ‘ã‚¹ï¼ˆä»»æ„ï¼‰</label>
                    <input id="thumbnailUrl" name="thumbnailUrl" type="text" placeholder="images/news001.png">
                    <small>â€» ä¸Šã®ç”»åƒç®¡ç†ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸå ´åˆã¯ images/ãƒ•ã‚¡ã‚¤ãƒ«å.png ã®ã‚ˆã†ã«æŒ‡å®š</small>
                </div>

                <div class="form-row">
                    <label for="excerpt">æ¦‚è¦ï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="excerpt" name="excerpt" rows="2" placeholder="ä¸€è¦§ã«è¡¨ç¤ºã™ã‚‹çŸ­ã„èª¬æ˜"></textarea>
                </div>

                <div class="form-row">
                    <label for="body">æœ¬æ–‡ï¼ˆHTMLå¯ï¼‰</label>
                    <div class="html-buttons">
                        <button type="button" class="html-btn" onclick="insertTag('p')">&lt;p&gt;</button>
                        <button type="button" class="html-btn" onclick="insertTag('h2')">&lt;h2&gt;</button>
                        <button type="button" class="html-btn" onclick="insertTag('ul')">&lt;ul&gt;</button>
                        <button type="button" class="html-btn" onclick="insertTag('li')">&lt;li&gt;</button>
                        <button type="button" class="html-btn" onclick="insertLink()">&lt;a href&gt;</button>
                    </div>
                    <textarea id="body" name="body" rows="10" placeholder="<p>æœ¬æ–‡ã‚’å…¥åŠ›</p>"></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                    <button type="button" id="resetBtn" class="btn btn-secondary">ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                    <button type="button" id="resetDataBtn" class="btn btn-secondary">åˆæœŸãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™</button>
                </div>
            </form>

            <div class="news-editor-preview">
                <div class="preview-header">
                    <h3>ç¾åœ¨ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ä¸€è¦§</h3>
                    <p class="preview-note">ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ï¼å‰Šé™¤</p>
                </div>
                <div id="newsList" class="news-editor-list"></div>
            </div>
        </div>
    </section>

    <footer style="text-align: center; padding: 2rem; border-top: 1px solid #2a2a2a;">
        <p style="font-size: 0.7rem; color: #666;">&copy; 2025 RAID3. All rights reserved.</p>
    </footer>

    <script src="../news-data.js"></script>
    <script>
        // ==================== å®šæ•°ãƒ»åˆæœŸåŒ– ====================
        const SITE_URL = 'https://raid3.vercel.app';
        const TAGS = ['ANNOUNCEMENT', 'TEAM', 'EVENT', 'STORE', 'STREAM', 'WEB3'];
        const DB_NAME = 'raid3_news_db';
        const DB_VERSION = 1;
        let db = null;
        let uploadedImages = {};
        let editId = null;

        // DOMè¦ç´ 
        const form = document.getElementById('newsForm');
        const newsIdInput = document.getElementById('newsId');
        const titleInput = document.getElementById('title');
        const dateInput = document.getElementById('date');
        const excerptInput = document.getElementById('excerpt');
        const bodyInput = document.getElementById('body');
        const thumbUrlInput = document.getElementById('thumbnailUrl');
        const tagBox = document.getElementById('tagCheckboxes');
        const listWrap = document.getElementById('newsList');
        const resetBtn = document.getElementById('resetBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');

        // ==================== IndexedDBï¼ˆç”»åƒä¿å­˜ç”¨ï¼‰ ====================
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains('images')) {
                        database.createObjectStore('images', { keyPath: 'filename' });
                    }
                };
            });
        }

        async function saveImage(filename, data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction('images', 'readwrite');
                tx.objectStore('images').put({ filename, data, timestamp: Date.now() });
                tx.oncomplete = () => { uploadedImages[filename] = data; resolve(); };
                tx.onerror = () => reject(tx.error);
            });
        }

        async function loadAllImages() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction('images', 'readonly');
                const request = tx.objectStore('images').getAll();
                request.onsuccess = () => {
                    uploadedImages = {};
                    request.result.forEach(img => { uploadedImages[img.filename] = img.data; });
                    resolve(uploadedImages);
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function deleteImage(filename) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction('images', 'readwrite');
                tx.objectStore('images').delete(filename);
                tx.oncomplete = () => { delete uploadedImages[filename]; resolve(); };
                tx.onerror = () => reject(tx.error);
            });
        }

        // ==================== ç”»åƒç®¡ç†UI ====================
        function renderImageGrid() {
            const grid = document.getElementById('imageGrid');
            const filenames = Object.keys(uploadedImages);
            document.getElementById('imageCount').textContent = filenames.length;
            
            if (!filenames.length) {
                grid.innerHTML = '<p style="color:#666; grid-column: 1/-1; font-size: 0.8rem;">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            grid.innerHTML = filenames.map(filename => `
                <div class="image-item">
                    <img src="${uploadedImages[filename]}" alt="${filename}">
                    <div class="image-item-info">${filename}</div>
                    <button class="image-item-delete" onclick="handleDeleteImage('${filename}')">Ã—</button>
                </div>
            `).join('');
        }

        async function handleDeleteImage(filename) {
            if (confirm(`${filename} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                await deleteImage(filename);
                renderImageGrid();
            }
        }

        function handleImageUpload(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    await saveImage(file.name, e.target.result);
                    renderImageGrid();
                };
                reader.readAsDataURL(file);
            });
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        const uploadArea = document.getElementById('imageUploadArea');
        const imageInput = document.getElementById('imageInput');
        uploadArea.addEventListener('click', () => imageInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleImageUpload(e.dataTransfer.files);
        });
        imageInput.addEventListener('change', (e) => handleImageUpload(e.target.files));

        // ==================== ã‚¿ã‚°é¸æŠå¼ ====================
        function buildTagInputs() {
            tagBox.innerHTML = '';
            TAGS.forEach(tag => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = tag;
                label.appendChild(input);
                label.appendChild(document.createTextNode(` #${tag}`));
                tagBox.appendChild(label);
            });
        }

        function getCheckedTags() {
            return Array.from(tagBox.querySelectorAll('input:checked')).map(i => i.value);
        }

        function setCheckedTags(tags) {
            tagBox.querySelectorAll('input').forEach(input => {
                input.checked = tags.includes(input.value);
            });
        }

        // ==================== HTMLã‚¿ã‚°æŒ¿å…¥ ====================
        function insertTag(tagName) {
            const textarea = bodyInput;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);
            
            const newText = `<${tagName}>${selectedText}</${tagName}>`;
            textarea.value = before + newText + after;
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´
            const cursorPos = start + tagName.length + 2 + selectedText.length;
            textarea.focus();
            textarea.setSelectionRange(cursorPos, cursorPos);
        }

        function insertLink() {
            const url = prompt('ãƒªãƒ³ã‚¯URLã‚’å…¥åŠ›:', 'https://');
            if (!url) return;
            
            const textarea = bodyInput;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end) || 'ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ';
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);
            
            const newText = `<a href="${url}">${selectedText}</a>`;
            textarea.value = before + newText + after;
            textarea.focus();
        }

        // ==================== ãƒ‹ãƒ¥ãƒ¼ã‚¹ç®¡ç† ====================
        function getNews() {
            if (window.NewsData && window.NewsData.getAll) {
                return window.NewsData.getAll();
            }
            try {
                const stored = localStorage.getItem('raid3_news_admin');
                return stored ? JSON.parse(stored) : [];
            } catch (e) { return []; }
        }

        function saveNewsToStorage(news) {
            localStorage.setItem('raid3_news_admin', JSON.stringify(news));
        }

        function renderList() {
            const items = getNews();
            document.getElementById('newsCount').textContent = items.length;
            
            if (!items.length) {
                listWrap.innerHTML = '<p style="color:#666;">ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            listWrap.innerHTML = '';
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'news-editor-card';

                const header = document.createElement('div');
                header.className = 'news-editor-card-head';

                const title = document.createElement('h4');
                title.textContent = item.title;

                const meta = document.createElement('span');
                meta.className = 'news-editor-meta';
                meta.textContent = `ID: ${item.id} | ${item.date || 'æ—¥ä»˜ãªã—'}`;

                header.appendChild(title);
                header.appendChild(meta);

                const tags = document.createElement('div');
                tags.className = 'news-editor-tags';
                (item.tags || []).forEach(tag => {
                    const badge = document.createElement('span');
                    badge.className = 'news-tag';
                    badge.textContent = `#${tag}`;
                    tags.appendChild(badge);
                });

                const actions = document.createElement('div');
                actions.className = 'news-editor-actions';

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.textContent = 'ç·¨é›†';
                editBtn.onclick = () => fillForm(item);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-secondary';
                deleteBtn.style.background = '#ef4444';
                deleteBtn.style.borderColor = '#ef4444';
                deleteBtn.textContent = 'å‰Šé™¤';
                deleteBtn.onclick = () => {
                    if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                        const news = getNews().filter(n => n.id !== item.id);
                        saveNewsToStorage(news);
                        renderList();
                    }
                };

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);

                card.appendChild(header);
                card.appendChild(tags);
                card.appendChild(actions);
                listWrap.appendChild(card);
            });
        }

        function fillForm(item) {
            document.getElementById('editId').value = item.id;
            newsIdInput.value = item.id;
            titleInput.value = item.title || '';
            dateInput.value = item.date || '';
            excerptInput.value = item.excerpt || '';
            bodyInput.value = item.body || '';
            thumbUrlInput.value = item.thumbnail || '';
            setCheckedTags(item.tags || []);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function handleSubmit(e) {
            e.preventDefault();
            
            const id = newsIdInput.value.trim();
            const title = titleInput.value.trim();
            
            if (!id || !title) {
                alert('IDã¨ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™');
                return;
            }

            const news = getNews();
            const existingEditId = document.getElementById('editId').value;
            
            // æ–°è¦è¿½åŠ æ™‚ã«IDãŒé‡è¤‡ã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            if (!existingEditId && news.some(n => n.id === id)) {
                alert('ã“ã®IDã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™');
                return;
            }

            const payload = {
                id: id,
                title: title,
                date: dateInput.value || new Date().toISOString().slice(0, 10),
                tags: getCheckedTags(),
                thumbnail: thumbUrlInput.value.trim() || '',
                excerpt: excerptInput.value.trim(),
                body: bodyInput.value.trim() || '<p>æœ¬æ–‡ãŒæº–å‚™ä¸­ã§ã™ã€‚</p>'
            };

            if (existingEditId) {
                // ç·¨é›†
                const index = news.findIndex(n => n.id === existingEditId);
                if (index !== -1) {
                    news[index] = payload;
                }
            } else {
                // æ–°è¦è¿½åŠ 
                news.unshift(payload);
            }

            saveNewsToStorage(news);
            alert('ä¿å­˜ã—ã¾ã—ãŸï¼\n\nå…¬é–‹ã™ã‚‹ã«ã¯ã€ŒZIPã§ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚’æŠ¼ã—ã¦GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            resetForm();
            renderList();
        }

        function resetForm() {
            document.getElementById('editId').value = '';
            form.reset();
            setCheckedTags([]);
            dateInput.value = new Date().toISOString().slice(0, 10);
        }

        function clearAllData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                localStorage.removeItem('raid3_news_admin');
                indexedDB.deleteDatabase(DB_NAME);
                uploadedImages = {};
                location.reload();
            }
        }

        // ==================== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ====================
        async function exportZip() {
            const btn = document.getElementById('exportZipBtn');
            btn.disabled = true;
            btn.textContent = 'â³ ä½œæˆä¸­...';

            try {
                const zip = new JSZip();
                const news = getNews();

                // news-data.js ã‚’ç”Ÿæˆ
                const newsDataJs = generateNewsDataJS(news);
                zip.file('news-data.js', newsDataJs);

                // å€‹åˆ¥è¨˜äº‹HTMLã‚’ç”Ÿæˆ
                const newsFolder = zip.folder('news');
                news.forEach(item => {
                    const html = generateArticleHTML(item);
                    newsFolder.file(`${item.id}.html`, html);
                });

                // ç”»åƒã‚’ZIPã«è¿½åŠ 
                const imgFolder = zip.folder('images');
                for (const [filename, data] of Object.entries(uploadedImages)) {
                    const base64 = data.split(',')[1];
                    imgFolder.file(filename, base64, { base64: true });
                }

                // ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `raid3-news-${new Date().toISOString().slice(0, 10)}.zip`;
                a.click();
                URL.revokeObjectURL(url);

                alert(`ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸï¼\n\nå«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:\nãƒ»news-data.js\nãƒ»news/${news.map(n => n.id + '.html').join(', ')}\nãƒ»images/${Object.keys(uploadedImages).join(', ') || 'ãªã—'}\n\nè§£å‡ã—ã¦GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚`);
            } catch (e) {
                console.error(e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“¥ ZIPã§ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            }
        }

        function generateNewsDataJS(news) {
            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            const sorted = [...news].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return `// RAID3 News Data - Generated ${new Date().toISOString()}
(function() {
    const defaultNews = ${JSON.stringify(sorted, null, 2)};
    const TAGS = ['ANNOUNCEMENT', 'TEAM', 'EVENT', 'STORE', 'STREAM', 'WEB3'];
    function getStoredNews() { try { const s = localStorage.getItem('raid3_news'); return s ? JSON.parse(s) : null; } catch(e) { return null; } }
    function saveNews(n) { try { localStorage.setItem('raid3_news', JSON.stringify(n)); } catch(e) {} }
    function getNews() { return getStoredNews() || defaultNews; }
    function sortByDate(items) { return [...items].sort((a, b) => new Date(b.date) - new Date(a.date)); }
    window.NewsData = {
        getAll: function() { return sortByDate(getNews()); },
        getById: function(id) { return getNews().find(n => n.id === id); },
        add: function(item) { const n = getNews(); n.unshift(item); saveNews(n); },
        update: function(id, u) { const n = getNews(); const i = n.findIndex(x => x.id === id); if(i !== -1) { n[i] = {...n[i], ...u}; saveNews(n); } },
        remove: function(id) { saveNews(getNews().filter(n => n.id !== id)); },
        reset: function() { localStorage.removeItem('raid3_news'); },
        TAGS: TAGS
    };
})();`;
        }

        function generateArticleHTML(item) {
            const title = escapeHtml(item.title);
            const desc = item.excerpt || (item.body ? escapeHtml(item.body.replace(/<[^>]*>/g, '').substring(0, 100)) : 'RAID3 - Web3 Gaming is Inevitable');
            
            // OGPç”»åƒURL
            let ogImage = `${SITE_URL}/images/R3aicon.png`;
            if (item.thumbnail) {
                if (item.thumbnail.startsWith('http')) {
                    ogImage = item.thumbnail;
                } else if (item.thumbnail.startsWith('images/')) {
                    ogImage = `${SITE_URL}/${item.thumbnail}`;
                } else {
                    ogImage = `${SITE_URL}/images/${item.thumbnail}`;
                }
            }
            
            const articleUrl = `${SITE_URL}/news/${item.id}.html`;

            return `<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${title} | RAID3</title>
<link rel="icon" href="../images/R3aicon.png" type="image/png">
<link rel="apple-touch-icon" href="../images/R3aicon.png">
<meta property="og:type" content="article">
<meta property="og:site_name" content="RAID3">
<meta property="og:title" content="${title} | RAID3">
<meta property="og:description" content="${desc}">
<meta property="og:image" content="${ogImage}">
<meta property="og:url" content="${articleUrl}">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@raid3__">
<meta name="twitter:title" content="${title} | RAID3">
<meta name="twitter:description" content="${desc}">
<meta name="twitter:image" content="${ogImage}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../styles.css">
</head>
<body>
<nav id="navbar">
<a href="../index.html">
<svg class="logo-svg" viewBox="0 0 726.3667 231.57715" xmlns="http://www.w3.org/2000/svg"><g transform="translate(-412,-327.5)"><path fill="#ffffff" d="M 412,445 V 331 l 36.25,0.0195 c 39.70236,0.0214 52.44438,1.06623 64.61382,5.29835 21.50077,7.47722 35.03722,21.82265 40.74698,43.18213 2.91852,10.91777 2.6945,37.05288 -0.41515,48.43317 -6.82921,24.99271 -21.25152,41.90747 -42.19972,49.49263 -3.15061,1.14081 -5.83977,2.44977 -5.9759,2.90879 -0.13613,0.45903 12.51617,17.97453 28.11623,38.92335 15.60006,20.94881 28.51634,38.46855 28.70286,38.93276 0.18652,0.46421 -11.02435,0.72371 -24.91303,0.57666 L 511.67393,558.5 482.58697,517.5553 453.5,476.61061 453.23891,517.8053 452.97781,559 H 432.48891 412 Z m 68.20078,9.87562 c 12.15861,-2.57979 22.56871,-10.69363 28.22437,-21.99863 4.70642,-9.40757 5.89723,-16.06687 5.33639,-29.84222 -0.60389,-14.83252 -2.93334,-21.36434 -10.16533,-28.50378 -7.94303,-7.84138 -14.14884,-9.70079 -34.34621,-10.29097 L 453,363.76518 V 409.88259 456 h 10.95078 c 6.02293,0 13.33543,-0.50597 16.25,-1.12438 z M 568,558.24755 c 0,-0.4345 21.53555,-52.53045 47.85679,-115.76878 C 653.4108,352.25302 664.08802,327.5 665.45292,327.5 c 1.36368,0 11.98218,24.51367 49.1644,113.5 26.08378,62.425 47.6893,114.5125 48.01228,115.75 l 0.58722,2.25 H 741.29431 719.3718 l -6.31169,-16.5 -6.31169,-16.5 h -40.7915 -40.7915 l -1.5893,4.25 c -0.87411,2.3375 -3.55789,9.65 -5.96396,16.25 l -4.37466,12 -22.61875,0.26877 C 578.17844,558.9166 568,558.68205 568,558.24755 Z m 126,-64.80929 c 0,-0.30895 -5.36581,-14.59645 -11.92402,-31.75 -6.55821,-17.15354 -12.94832,-34.67564 -14.20026,-38.938 -1.25193,-4.26236 -2.59245,-7.41236 -2.97894,-7 -0.38649,0.41236 -1.69494,4.32651 -2.90766,8.69812 -1.21273,4.37161 -6.70328,20.12161 -12.20123,35 -5.49796,14.87839 -10.60443,28.73912 -11.34773,30.80162 l -1.35144,3.75 h 28.45564 C 681.19496,494 694,493.74722 694,493.43826 Z M 785,445 V 331 H 805.5 826 V 445 559 H 805.5 785 Z m 94.66667,113.33333 C 879.3,557.96667 879,506.62667 879,444.24445 V 330.82224 l 39.25,0.46751 c 41.28404,0.49174 45.57029,0.90035 60.71135,5.78763 31.34345,10.11713 51.21355,33.74637 59.21915,70.42262 2.8755,13.17355 3.6376,45.10965 1.4335,60.07259 -7.6233,51.75283 -36.7642,83.38026 -82.86316,89.93354 -10.62663,1.51065 -75.70239,2.20899 -77.08417,0.8272 z m 75.20237,-37.77058 c 19.71864,-5.30527 34.23089,-21.54403 40.115,-44.88745 6.49416,-25.76352 4.92088,-55.48052 -4.06216,-76.72937 C 980.43795,374.14679 964.00903,364 934.34004,364 H 922 v 79.65555 79.65555 l 13.75,-0.65191 c 7.5625,-0.35855 16.16607,-1.30194 19.11904,-2.09644 z M 1087.112,471.81347 c -6.7863,-0.76753 -18.2936,-5.73109 -23.4478,-10.11397 l -2.8357,-2.41141 4.5674,-7.12575 4.5675,-7.12574 5.5539,3.89049 c 12.3712,8.66607 27.4686,7.68657 36.2845,-2.35408 3.2104,-3.65651 5.9582,-11.06146 6.1982,-16.81169 0.3377,-8.08947 -5.1381,-17.55691 -12.4293,-20.86851 -4.6493,-2.11166 -15.756,-2.52439 -21.9145,-0.81434 -2.114,0.58703 -4.0803,0.83072 -4.3695,0.54153 -0.2892,-0.28918 5.359,-9.65948 12.5514,-20.82289 L 1104.9154,367.5 1086.7077,367 1068.5,366.5 l -0.2889,-8.75 -0.289,-8.75 32.098,0.19715 c 25.3881,0.15593 31.9502,-0.5273 31.3913,0.46141 -0.3887,0.6875 -6.4902,11.12482 -13.559,22.47117 -7.0688,11.34635 -12.8524,20.87156 -12.8524,21.16714 0,0.29557 2.2649,1.02313 5.033,1.61679 10.5431,2.2611 17.3498,8.63299 22.6769,16.90474 3.0945,4.80496 5.5,12.03856 5.6486,18.47733 0.1453,6.29408 -1.6551,13.69269 -4.6825,18.29764 -10.3437,15.73344 -26.0616,25.53892 -46.564,23.2201 z"/></g></svg>
</a>
<ul class="nav-links">
<li><a href="index.html">News</a></li>
<li><a href="../index.html#creators">Creators</a></li>
<li><a href="../index.html#about">About</a></li>
<li><a href="https://suzuri.jp/RAID3" target="_blank">Store</a></li>
</ul>
</nav>
<article class="news-article">
<header class="news-article-header">
<a href="index.html" class="news-article-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>Back to News</a>
<div class="news-article-tags">${(item.tags || []).map(t => `<span class="news-tag">#${escapeHtml(t)}</span>`).join('')}</div>
<h1 class="news-article-title">${title}</h1>
<p class="news-article-date">${item.date || ''}</p>
</header>
<div class="news-article-image">${item.thumbnail ? `<img src="../${item.thumbnail}" alt="${title}">` : 'R3'}</div>
<div class="news-article-body">${item.body || '<p>æœ¬æ–‡ãŒæº–å‚™ä¸­ã§ã™ã€‚</p>'}</div>
<div class="news-article-share"><p>Share</p><div class="share-buttons">
<a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(articleUrl)}&text=${encodeURIComponent(item.title + ' | RAID3')}" target="_blank" class="share-btn">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
</a></div></div>
</article>
<footer style="text-align: center; padding: 2rem; border-top: 1px solid #2a2a2a;"><p style="font-size: 0.7rem; color: #666;">&copy; 2025 RAID3. All rights reserved.</p></footer>
</body></html>`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== åˆæœŸåŒ– ====================
        async function init() {
            await initDB();
            await loadAllImages();
            buildTagInputs();
            dateInput.value = new Date().toISOString().slice(0, 10);
            renderImageGrid();
            renderList();

            form.addEventListener('submit', handleSubmit);
            resetBtn.addEventListener('click', resetForm);
            resetDataBtn.addEventListener('click', () => {
                if (confirm('åˆæœŸãƒ‡ãƒ¼ã‚¿ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
                    localStorage.removeItem('raid3_news_admin');
                    if (window.NewsData && window.NewsData.reset) {
                        window.NewsData.reset();
                    }
                    renderList();
                    resetForm();
                }
            });
        }

        init();
    </script>
</body>
</html>
